- type: producer
  name: sample-producer
  app:
    replicaCount: 1
    image: ks23-registry:5000/ks23/ks23-producer
    imageTag: 1.0-SNAPSHOT
    deployment: true
    commandLine:
      KS23_PRODUCER_SAMPLE_ENABLED: "true"
    resources:
      limits:
        cpu: 2
        memory: 500Mi
      requests:
        cpu: 500m
        memory: 500Mi
  to:
    topics:
      ${pipeline_name}-sample:
        type: extra
        role: sample
        partitions_count: 5
- type: streams-app
  name: sample-preprocessor
  app:
    replicaCount: 1
    image: ks23-registry:5000/ks23/ks23-preprocessor
    imageTag: 1.0-SNAPSHOT
    commandLine:
      ID: preprocessor
    resources:
      limits:
        cpu: 2
        memory: 600Mi
      requests:
        cpu: 500m
        memory: 600Mi
  from:
    topics:
      ${pipeline_name}-sample:
        type: extra
        role: sample
      ${pipeline_name}-ad-feature:
        type: extra
        role: ad-feature
      ${pipeline_name}-user-profile:
        type: extra
        role: user-profile
  to:
    topics:
      ${pipeline_name}-full-sample:
        type: output
        partitions_count: 5
      ${pipeline_name}-preprocessor-error:
        type: error
        partitions_count: 4
- type: rest-service
  name: user-api
  app:
    image:
      repository: ks23-registry:5000/ks23/ks23-rest-service
      pullPolicy: Always
      tag: 1.0-SNAPSHOT
    app:
      config: |
        ks23.rest.latency-millis.mean=200
        ks23.rest.latency-millis.std-dev=40
        ks23.rest.blocking-millis.mean=50
        ks23.rest.blocking-millis.std-dev=10
- type: rest-service
  name: ad-api
  app:
    image:
      repository: ks23-registry:5000/ks23/ks23-rest-service
      pullPolicy: Always
      tag: 1.0-SNAPSHOT
    app:
      config: |
        ks23.rest.latency-millis.mean=250
        ks23.rest.latency-millis.std-dev=50
        ks23.rest.blocking-millis.mean=500
        ks23.rest.blocking-millis.std-dev=50
- type: streams-app
  name: integrator
  app:
    replicaCount: 1
    image: ks23-registry:5000/ks23/ks23-integrator
    imageTag: 1.0-SNAPSHOT
    commandLine:
      ID: integrator
      INTEGRATOR_CACHE_ENABLED: "false"
      INTEGRATOR_CACHE_TYPE: MEMORY
      INTEGRATOR_USER_URL: http://user-api-rest-service
      INTEGRATOR_AD_URL: http://ad-api-rest-service
    resources:
      limits:
        cpu: 2
        memory: 600Mi
      requests:
        cpu: 500m
        memory: 600Mi
    autoscaling:
      consumerGroup: integrator
      lagThreshold: 5 # Average target value to trigger scaling actions.
      enabled: true
      pollingInterval: 30
      cooldownPeriod: 300
      offsetResetPolicy: earliest
      maxReplicas: 5
      minReplicas: 0
  from:
    topics:
      ${pipeline_name}-full-sample:
        type: input
  to:
    topics:
      ${pipeline_name}-sample-prediction:
        type: output
        partitions_count: 5
      ${pipeline_name}-integrator-error:
        type: error
        partitions_count: 4
